<?php
/** @var \Magento\Framework\View\Element\Template $block */
/** @var \Magento\Catalog\Model\Product $product */
$product = $block->getProduct();
if (!$product || !$product->getId()) { echo "<!-- Producto no encontrado para JSON-LD -->"; return; }

$price   = (float)$product->getFinalPrice();
$currency = $block->getCurrency() ?? 'CLP';

// Asegura al menos 1-2 URLs de imagen (WebP + fallback)
$mainImg = $block->getImageUrl($product); // tu helper
$imgWebp = preg_replace('/\.(jpe?g|png)(\?.*)?$/i', '.webp', $mainImg);
$images  = array_values(array_unique(array_filter([$imgWebp, $mainImg])));

$priceValidUntil = date('Y-m-d', strtotime('+1 year'));
$descValue = $product->getShortDescription() ?: $product->getDescription() ?: '';
$cleanDescription = strip_tags((string)$descValue);

$productUrl = $product->getProductUrl();

$productData = [
  '@context' => 'https://schema.org',
  '@type'    => 'Product',
  '@id'      => $productUrl . '#Product',
  'name'     => $product->getName(),
  'description' => $cleanDescription,
  'sku'      => $product->getSku(),
  'mpn'      => $product->getSku(),
  'brand'    => ['@type' => 'Brand','name' => 'Multicomercio'],
  'image'    => $images,
  'offers'   => [
    '@type' => 'Offer',
    '@id'   => $productUrl . '#Offer',
    'url'   => $productUrl,
    'priceCurrency' => $currency,
    'price' => $price, // número, no string formateada
    'availability'   => 'https://schema.org/' . ($product->isAvailable() ? 'InStock' : 'OutOfStock'),
    'itemCondition'  => 'https://schema.org/NewCondition',
    'priceValidUntil'=> $priceValidUntil,
    'priceSpecification' => [
      '@type' => 'UnitPriceSpecification',
      'price' => $price,
      'priceCurrency' => $currency,
      'valueAddedTaxIncluded' => true
    ],
    'shippingDetails' => [
      '@type' => 'OfferShippingDetails',
      'shippingDestination' => ['@type' => 'DefinedRegion', 'addressCountry' => 'CL'],
      'deliveryTime' => [
        '@type' => 'ShippingDeliveryTime',
        'handlingTime' => ['@type' => 'QuantitativeValue','minValue' => 1,'maxValue' => 2,'unitCode' => 'd'],
        'transitTime'   => ['@type' => 'QuantitativeValue','minValue' => 2,'maxValue' => 5,'unitCode' => 'd']
      ],
      'shippingRate' => ['@type' => 'MonetaryAmount','value' => 2990,'currency' => $currency]
    ],
    'hasMerchantReturnPolicy' => [
      '@type' => 'MerchantReturnPolicy',
      'applicableCountry' => 'CL',
      'returnPolicyCategory' => 'https://schema.org/MerchantReturnFiniteReturnWindow',
      'merchantReturnDays' => 10,
      'returnMethod' => 'https://schema.org/ReturnByMail',
      'returnFees'   => 'https://schema.org/FreeReturn'
    ]
  ],
  // Opcionales (Google puede ignorarlos si sospecha contenido sintético, pero no causan error)
  'aggregateRating' => [
    '@type' => 'AggregateRating',
    'ratingValue' => '4.8',
    'reviewCount' => '12'
  ],
  'review' => [[
    '@type' => 'Review',
    'author' => ['@type' => 'Person','name' => 'Carlos Soto'],
    'datePublished' => '2024-12-10',
    'reviewBody' => 'Muy buen producto, lo usamos en nuestro local y funciona perfecto.',
    'name' => 'Excelente para uso comercial',
    'reviewRating' => ['@type' => 'Rating','ratingValue' => '5','bestRating' => '5']
  ]]
];
?>
<script type="application/ld+json">
<?= json_encode($productData, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT) ?>
</script>
